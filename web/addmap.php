<?php

header("Content-Type: text/plain");
header("Expires: ".GMDate("D, d M Y H:i:s")." GMT");

////////////////////////////////////////////////////////////////////////////////
// setup properties
////////////////////////////////////////////////////////////////////////////////

$wwwDir = dirname(__FILE__);
$rootDir = $wwwDir . '/';

////////////////////////////////////////////////////////////////////////////////
// permission
////////////////////////////////////////////////////////////////////////////////

if (!array_key_exists('secret', $_GET)){
	header("401 Unauthorized");
	echo "Undefined secret!\n";
	die();
}

$secret = include( $rootDir . '/secret.php' );

if ($_GET['secret'] != $secret){
	header("401 Unauthorized");
	echo "Invalid secret!\n";
	die();
}

////////////////////////////////////////////////////////////////////////////////
// check arguments
////////////////////////////////////////////////////////////////////////////////

if (!(array_key_exists('map', $_GET) || 
	  array_key_exists('version', $_GET) || 
	  array_key_exists('directory', $_GET))){
	header("400 Too few arguments");
	echo "Too few arguments!\n";
	die();
}

$map=$_GET['map'];
$version=$_GET['version'];
$directory=$_GET['directory'];

////////////////////////////////////////////////////////////////////////////////
// Load libs
////////////////////////////////////////////////////////////////////////////////

require_once $rootDir . '/lib/Nette/loader.php';

////////////////////////////////////////////////////////////////////////////////
// initialize common libraries
////////////////////////////////////////////////////////////////////////////////

$database = include( $rootDir . '/database.php' );

echo "map=$map\n";
echo "version=$version\n";
echo "directory=$directory\n";

// TODO: add entry to database

echo "\n";
echo "OK\n";
